<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <meta content="IE=edge" http-equiv="X-UA-Compatible">
    <meta content="width=device-width, initial-scale=1" name="viewport">
    <meta content="" name="description">
    <meta content="" name="author">



    <!--remote libraries e.g. cdn -->
    <script src="http://ajax.googleapis.com/ajax/libs/jquery/1.11.3/jquery.min.js"></script>

    <!-- Bootstrap Core CSS -->
    <link href="css/bootstrap.min.css" rel="stylesheet">

    <!-- Custom CSS -->
    <link href="css/simple-sidebar.css" rel="stylesheet">

    <link rel="stylesheet" href="http://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.3/leaflet.css" />

    <script src="http://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.3/leaflet.js"></script>

    <link href="../../favicon.ico" rel="icon">

    <script src="js/bootstrap-datepicker.js"></script>

    <link rel="stylesheet" href="css/datepicker.css">

    <script src="js/bootstrap-datepicker.js"></script>

    <link rel="stylesheet" href="css/datepicker.css">

    <style>
        .content {
            margin-left: 248px !important;
        }
        
        .navbar-inverse {
            background-color: #000 !important;
        }
    </style>
    <title class=".visible-md-* .visible-lg-*">Wiley: Navigating the data jungle</title>
</head>

<body>
    <!-- top navbar -->
    <!--<div class="container">-->
    <!-- Sidebar -->
    <div id="sidebar-wrapper">
        <ul class="sidebar-nav">
            <li class="sidebar-brand">
                <a href="overview.html">
                    <img src="wiley.png" width="150" height="150">
                </a>
            </li>
            <br>
            <br>
            <br>
            <br>
            <li style="margin:1.0em;">
                <a href="index.html"><span class="glyphicon glyphicon-search" style="font-size:2.5em;"></span><font size="6" face="calibri" style="padding-left:1.0em;">Search</font></a>
            </li>
            <li style="margin:1.0em;">
                <a href="monitor.html"><span class="glyphicon glyphicon-signal" style="font-size:2.5em;"></span><font size="6" face="calibri" style="padding-left:1.0em;">Monitor</font></a>
            </li>
        </ul>
    </div>

    <!--        <div class="row-fluid">-->

    <div class="content">

        <nav class="navbar navbar-inverse">
            <div class="container-fluid">
                <div>
                    <ul class="nav navbar-nav navbar-right">
                        <li><a href="#">Install Notes</a></li>
                        <li><a href="#">Release Notes</a></li>
                        <li><a href="#">Help Files</a></li>

                    </ul>
                </div>
            </div>
        </nav>
        <!-- Sidebar -->
        <!--
            <div class="span12">
                <!--Body content-->
        <!--"col-sm-9  col-md-10main"-->
        <!--<div class = "row">-->
        <div class="col-md-4">
            <form class="form-horizontal">
                <fieldset style="height:450px;width:100%;">

                    <!-- Form Name -->
                    <legend>Search</legend>

                    <!-- Search input-->
                    <div class="form-group">
                        <label class="col-md-4 control-label" for="daterange">Date Range (*Required)</label>
                        <div class="col-md-8">
			<table>
			<td>
				<span title="(yyyy-mm-dd)">
                            <input class="form-control input-md" type="text" id="date-from" placeholder="From" data-date-format="yyyy-mm-dd"> 
				</span> 
			</td>
			<td>
				<span title="(yyyy-mm-dd)">
			    <input class="form-control input-md" type="text" id="date-to" placeholder="To" data-date-format="yyyy-mm-dd">
				</span> 
			</td>
                        </table>   
							
                            <input  type="hidden" id="date-from-internal" >
                            <input  type="hidden" id="date-to-internal">
							
                        </div>
                    </div>

                    <!-- Select Basic -->
                    <div class="form-group">
                        <label class="col-md-4 control-label" for="selectlocation">Location (*Required)</label>
                        <div class="col-md-8">
			<div class="input-group input-group-md">
                            <select multiple id="selectlocation" name="selectlocation" class="form-control">
                                <option value="AL">Alabama</option>
                                <option value="AK">Alaska</option>
                                <option value="AS">American Samoa</option>
                                <option value="AZ">Arizona</option>
                                <option value="AR">Arkansas</option>
                                <option value="CA">California</option>
                                <option value="CO">Colorado</option>
                                <option value="CT">Connecticut</option>
                                <option value="DE">Delaware</option>
                                <option value="DC">District of Columbia</option>
                                <option value="FL">Florida</option>
                                <option value="GA">Georgia</option>
                                <option value="GU">Guam</option>
                                <option value="HI">Hawaii</option>
                                <option value="ID">Idaho</option>
                                <option value="IL">Illinois</option>
                                <option value="IN">Indiana</option>
                                <option value="IA">Iowa</option>
                                <option value="KS">Kansas</option>
                                <option value="KY">Kentucky</option>
                                <option value="LA">Louisiana</option>
                                <option value="ME">Maine</option>
                                <option value="MD">Maryland</option>
                                <option value="MA">Massachusetts</option>
                                <option value="MI">Michigan</option>
                                <option value="MN">Minnesota</option>
                                <option value="MS">Mississippi</option>
                                <option value="MO">Missouri</option>
                                <option value="MT">Montana</option>
                                <option value="NE">Nebraska</option>
                                <option value="NV">Nevada</option>
                                <option value="NH">New Hampshire</option>
                                <option value="NJ">New Jersey</option>
                                <option value="NM">New Mexico</option>
                                <option value="NY">New York</option>
                                <option value="NC">North Carolina</option>
                                <option value="ND">North Dakota</option>
                                <option value="MP">Northern Marianas Islands</option>
                                <option value="OH">Ohio</option>
                                <option value="OK">Oklahoma</option>
                                <option value="OR">Oregon</option>
                                <option value="PA">Pennsylvania</option>
                                <option value="PR">Puerto Rico</option>
                                <option value="RI">Rhode Island</option>
                                <option value="SC">South Carolina</option>
                                <option value="SD">South Dakota</option>
                                <option value="TN">Tennessee</option>
                                <option value="TX">Texas</option>
                                <option value="UT">Utah</option>
                                <option value="VT">Vermont</option>
                                <option value="VA">Virginia</option>
                                <option value="VI">Virgin Islands</option>
                                <option value="WA">Washington</option>
                                <option value="WV">West Virginia</option>
                                <option value="WI">Wisconsin</option>
                                <option value="WY">Wyoming</option>
                            </select>
				</div>
                        </div>
                    </div>



                    <!-- Text input-->
				<!--	<div class="form-group" > -->
                        <!--<label class="col-md-6 control-label" for="searchinput"><font size=3>Advanced Search</font></label>-->
<!--			<h4 style="margin-left: 0.5cm;">Advanced Search</h4> -->
<!--                    </div> -->
                    <div class="form-group">
                        <label class="col-md-4 control-label" for="keyword">Keyword</label>
                        <div class="col-md-8">

                            <input id="keyword" name="keyword" type="text" class="form-control input-md">
                            <!--<span class="help-block">(or dd/mm/yyyy-dd/mm/yyyy)</span>-->
                        </div>
                    </div>

                    <div class="form-group">
                        <label class="col-md-4 control-label" for="foodgroup">Food Group</label>
                        <div class="col-md-4">
			<span title="Does not include beverages, cake mix, sugary snacks, or animal food">
                            <select id="foodgroup" name="foodgroup" class="form-control">
				<option value="" selected="selected">None</option>
                                <option value="Fruits">Fruits</option>
                                <option value="Vegetables">Vegetables</option>
                                <option value="Grains">Grains</option>
                                <option value="Proteins">Proteins</option>
                                <option value="Dairy">Dairy</option>
			    </span>
                            </select>
			    
                        </div>
			<button id="btnSubmit" type="button" class="btn btn-default" style="width:130px">Submit Search</button>
                    </div>
                   
					
                    <!-- Text input-->
                    <script>
					function pad(n) {
					if (n < 10)
					return "0" + n;
					return n;
					}
                        $(document).ready(function() {
						
                            var checkin = $('#date-from').datepicker().on('changeDate', function(ev) {
								  

			    var dateVal1 = "/Date(" + ev.date.valueOf() + ")/";
			    var date = new Date( parseFloat( dateVal1.substr(6 )));
			    var begindate = date.getFullYear() + "-" + pad((date.getMonth() + 1)) + "-" + pad(date.getDate());
								  
								  
			        $('#date-from-internal').val(begindate);
                                $('#date-to')[0].focus();
                            }).data('datepicker');
                           var checkout = $('#date-to').datepicker({
                                onRender: function(date) {
                                    return date.valueOf() <= checkin.date.valueOf() ? 'disabled' : '';
                                }
                            }).on('changeDate', function(ev) {
				var dateVal1 = "/Date(" + ev.date.valueOf() + ")/";
				var date = new Date( parseFloat( dateVal1.substr(6 )));
				var enddate = date.getFullYear() + "-" +pad((date.getMonth() + 1)) + "-" + pad(date.getDate());
				$('#date-to-internal').val(enddate);
					
								
                            }).data('datepicker');
                        });
                    </script>

                    <div id="detailed-table" class="list-group col-md-8" style="overflow:auto; height:275px; width:425px;">

                    </div>
        </div>


        <div class="col-md-8">
            <div class="col-xs-6 col-sm-3 img-responsive" style="height:575px;width:100%" id="map">

            </div>
        </div>

    </div>



    <!--PlaceHolder Table-->
    <h2 class="sub-header" id="search-results"></h2>
    <!-- <div class="table-responsive">-->
    <!--<div class="container">-->


    <div id="detailed-table" class="list-group">

    </div>

    </div>
    </div>
    </div>
    </div>
    <!---this is for search functionality-->
    <script>
        /*Function that dynamically generates the search query results from the search form using JQuery as a means to append to the div for the
         *table
         *@param the json response received from the JQuery AJAX request
         */
function GetMultipleSelections(parameter) { 
  document.getElementById(parameter).size = 1;                // reduce screen size 
  var picked = ''; 
  for (i=0; i<document.getElementById(parameter).options.length; i++) { 
    if (document.getElementById(parameter).options[i].selected == true) { picked += document.getElementById(parameter)[i].value+','; } 
  }  
  document.getElementById(parameter).selectedIndex = -1;        // reset list 
  return picked; 
}
var start = new Date().getTime();
//•	http://localhost:<Port#>/dataIngestion/rest/data/searchQuery?bngDateRng=2004-05-20&endDateRng=2014-05-20&loc=MD&advSearch=Pizza&foodGroup=Meat
 $("#btnSubmit").click(function() {
					selectlocation = GetMultipleSelections('selectlocation');
                    selectlocation = selectlocation.substring(0, selectlocation.length-1);
                    console.log(selectlocation);                                                                             
                    foodgroup = document.getElementById('foodgroup').value;
                    //selectlocation = document.getElementById('selectlocation').value;
                    keyword = document.getElementById('keyword').value;
					begindate = document.getElementById('date-from-internal').value;
					enddate = document.getElementById('date-to-internal').value;
					var endpoint = 'http://localhost:8080/dataIngestion/rest/data/searchQuery?';
					var form_parameter = 'bngDateRng=' + begindate + '&endDateRng=' + enddate + '&loc=' + selectlocation + '&advSearch=' + keyword + '&foodGroup=' + foodgroup; //keywordSearch
					var full_search = endpoint + form_parameter;
					foodgroup = "";
					locationtarget = selectlocation;
					selectionlocation = "";
					searchword = keyword;
					keyword = "";
					begindate = "";
					enddate = "";
					console.log(full_search);
                    $.ajax({
                        'async': false,
			url: full_search
                        //url: 'https://api.fda.gov/food/enforcement.json?api_key=LEsaCnFqu5NnXynoyvcNjtaSTEde5r7inxEfcTIH',
                    
                    }).done(function(result) {
					var end = new Date().getTime();
				    var responseTime = end - start;
                        //Return the search results
			returnSearch(result);
			//post the statistics such as query count to monitor service
			$.ajax({
			type: 'POST',
			data: JSON.stringify({"searchField":searchword,"responseTime":responseTime, "location":locationtarget}),
			contentType: "application/json",
			dataType: "json",
			url: 'http://localhost:8080/dataIngestion/rest/monitor/query',
		})
                    });
					
                    function returnSearch(json_test) {
					    $( '#detailed-table' ).empty();
					    var num_results = '<h4><font face="calibri">' + json_test.results.bindings.length + ' Total Results</font></h4>';
					    $(num_results).appendTo('#detailed-table');
                        for (var i = 0; i < json_test.results.bindings.length; i++) {
			    var classification = json_test.results.bindings[i].classification.value;
		            var recall_status = json_test.results.bindings[i].status.value;
			    var notification_type = json_test.results.bindings[i].notification.value;
			    classification = classification.split('#Class');
			    recall_status = recall_status.split('#');
			    notification_type = notification_type.split('#');
			    var report_date = json_test.results.bindings[i].reportDate.value;
			    report_date = report_date.substr(0, report_date.indexOf('T'));
			    var recall_date = json_test.results.bindings[i].recallInitiationDate.value;
			    recall_date = recall_date.substr(0, recall_date.indexOf('T')); 
                            var elm = '<div class="list-group-item">' +
                                '<div data-toggle="collapse" data-parent="#detailed-table" href="#collapse' + i + '">' +
                                '<h4 class="list-group-item-heading"><b>Recall Number:</b> ' + json_test.results.bindings[i].recallNumber.value + '</h4>' +
                                '<p class="list-group-item-text">' +
                                '<span class="glyphicon glyphicon-calendar" aria-hidden="false"></span><span><b>Report Date</b>: ' + report_date + '</span>' +
                                '<span class="glyphicon glyphicon-map-marker" aria-hidden="false"></span><span><b>Location:</b>' + json_test.results.bindings[i].location.value + '</span>' +
                                '<span class="glyphicon glyphicon-info-sign" aria-hidden="false"></span><span><b>Recalling Firm:</b>' + json_test.results.bindings[i].recallingFirm.value + '</span>' +
                                '</p>' +
                                '</div>' +
                                '<div id="collapse' + i + '" class="panel-collapse collapse">' +
                                '<div class="panel-body">' +
                                '<ul class="list-unstyled">' +
                                '<li><b>Status:</b>' + json_test.results.bindings[i].status.value + '</li>' +
                                '<li><b>Distribution Pattern:</b>' + json_test.results.bindings[i].distPattern.value + '</li>' +
                                '<li><b>Product Quantity:</b>' + json_test.results.bindings[i].productQty.value + '</li>' +
                                '<li><b>Recall Initiation Date:</b>' + recall_date + '</li>' +
								
                                '<li><b>City/State:</b>' + json_test.results.bindings[i].location.value + '</li>' +
                                '<li><b>Event ID:</b>' + json_test.results.bindings[i].eventId.value + '</li>' +
                                '<li><b>Product Description:</b>' + json_test.results.bindings[i].productDescription.value + '</font></li>' +
                                '<li><b>Country:</b> US</li>' +

				'<li>Code Info: ' + json_test.results.bindings[i].codeInfo.value + '</li>' +
                                '<li><b>Recalling Firm:</b> ' + json_test.results.bindings[i].recallingFirm.value + '</li>' +
                                '<li><b>Recall Reason:</b> ' + json_test.results.bindings[i].recallReason.value + '</li>' +
                                '<li><b>Report Date:</b> ' + report_date + '</li>' +
                                '<li><b>Voluntary Mandated:</b> Voluntary: Firm Initiated</li>' +
                                '<li><b>Classification:</b>' + json_test.results.bindings[i].classification.value + '</li>' +
								
                                '</ul>' +
                                '</div>' +
                                '</div>' +
                                '</div>';
                            $(elm).appendTo('#detailed-table');
						
							//var map = L.map('map')
								//console.log(val);
								bounds.push([json_test.results.bindings[i].latitude.value, json_test.results.bindings[i].longitude.value]);
								L.marker([json_test.results.bindings[i].latitude.value, json_test.results.bindings[i].longitude.value], {
									icon: window.pizzaIcon
								}).addTo(map)
								.bindPopup('Recall Number: ' + json_test.results.bindings[i].recallNumber.value  );
							
							// zoom to bounds of markers

							map.fitBounds(bounds);
                        }
                    }
				});
		/*		
		$.ajax({
			type: 'POST',
			data: JSON.stringify(formData),
			contentType: "application/json",
			dataType: "json",
			url: 'http://localhost:8080/dataIngestion/rest/monitor/query',
		})*/
		
	//	$.ajax({
	//		type: 'POST',
	//		data: JSON.stringify(formData),
	//		contentType: "application/json",
	//		dataType: "json",
	//		url: 'http://localhost:8080/dataIngestion/rest/monitor/query',
	//	})
				
				
    </script>

    <script>
        var map = L.map('map').setView([31.0, -98.0], 10);

		
		var bounds = [];

        window.pizzaIcon = L.icon({
            iconUrl: 'celery.png',
            iconSize: [48, 48], // size of the icon
            iconAnchor: [22, 22], // point of the icon which will correspond to marker's location
            popupAnchor: [0, -22] // point from which the popup should open relative to the iconAnchor
        });


        L.tileLayer('https://{s}.tiles.mapbox.com/v3/{id}/{z}/{x}/{y}.png', {
            maxZoom: 18,
            attribution: 'Map data &copy; <a href="http://openstreetmap.org">OpenStreetMap</a> contributors, ' +
                '<a href="http://creativecommons.org/licenses/by-sa/2.0/">CC-BY-SA</a>, ' +
                'Imagery © <a href="http://mapbox.com">Mapbox</a>',
            id: 'examples.map-i875mjb7'
        }).addTo(map);


        L.marker([51.5, -0.09]).addTo(map)

        L.circle([51.508, -0.11], 500, {
            color: 'red',
            fillColor: '#f03',
            fillOpacity: 0.5
        }).addTo(map).bindPopup("I am a circle.");

        L.polygon([
            [51.509, -0.08],
            [51.503, -0.06],
            [51.51, -0.047]
        ]).addTo(map).bindPopup("I am a polygon man.");

        var popup = L.popup();

        function onMapClick(e) {

            getVector();

            popup
                .setLatLng(e.latlng)
                .setContent("You clicked the map at " + e.latlng.toString())
                .openOn(map);
        }


        //Query Claven for lat/longs ...
	/*	
        function getVector() {
            //alert($("#id_textarea").val());
            //console.log($("#id_textarea").val());
            $.ajax({
                    url: "http://localhost:8080/api/v0/geotag",
                    type: "POST",
                    contentType: "text/plain",
                    data: "Texas, US"
                })
                //data: $("#id_textarea").val()
                .done(function(data) {
                    //console.log(data);
                    $("#results").text(JSON.stringify(data));

                    // add results to map
                    var bounds = [];
                    $.each(data.resolvedLocations, (function(idx, val) {
                        //console.log(val);
                        bounds.push([val.geoname.latitude, val.geoname.longitude]);
                        L.marker([val.geoname.latitude, val.geoname.longitude], {
                                icon: window.pizzaIcon
                            }).addTo(map)
                            .bindPopup(val.geoname.name);
                    }));

                    // zoom to bounds of markers
                    map.fitBounds(bounds);

                });
        }


*/

        map.on('click', onMapClick);
    </script>

    <!-- Bootstrap Core JavaScript -->
    <script src="js/bootstrap.min.js"></script>

    <!-- Menu Toggle Script -->
    <script>
        $("#menu-toggle").click(function(e) {
            e.preventDefault();
            $("#wrapper").toggleClass("toggled");
        });
    </script>

</body>

<script src="http://d3js.org/d3.v3.min.js"></script>


</html>
